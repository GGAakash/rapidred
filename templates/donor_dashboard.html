{% extends "base.html" %}
{% block title %}Donor Dashboard{% endblock %}
{% block content %}
<div class="card p-3">
  <h4>Welcome, {{ donor.name }}</h4>
  <div>
    <strong>Blood group:</strong> {{ donor.blood_group }}<br>
    <strong>Residential area:</strong> {{ donor.residential_area or '-' }}<br>
    <strong>Status:</strong> <span id="online-badge" class="badge bg-success" style="display: none">Online</span>
  </div>

  <div class="mt-3">
    <h6>Assigned Requests</h6>
    <div id="assigned-requests">
      {% if assigned_requests %}
        {% for ar in assigned_requests %}
          <div class="card p-2 mb-2">
            <b>Request #{{ ar.id }} — {{ ar.patient_name }}</b><br>
            Blood: {{ ar.required_blood_group }} • Status: <span class="badge bg-warning">{{ ar.status }}</span><br>
            Location: {{ ar.latitude }}, {{ ar.longitude }} 
            <div class="mt-2">
              <a class="btn btn-sm btn-outline-light" href="https://www.google.com/maps/dir/?api=1&destination={{ ar.latitude }},{{ ar.longitude }}" target="_blank">Start Directions</a>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted small">No assigned requests.</div>
      {% endif %}
    </div>
  </div>

  <div class="mt-3">
    <h6>Your Notifications</h6>
    <div id="my-notifs">
      {% if notifications %}
        <ul class="list-unstyled">
          {% for n in notifications %}
            <li>{{ n.created_at.strftime('%Y-%m-%d %H:%M') }} — {{ n.payload }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-muted small">No notifications yet.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  var socket = io();
  var donor_id = {{ donor.id }};
  socket.emit('join', {donor_id: donor_id});

  function shareLocation(){
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lon = pos.coords.longitude;
      document.getElementById('online-badge').style.display = 'inline-block';
      socket.emit('donor_share', {donor_id: donor_id, latitude: lat, longitude: lon});
    }, function(err){
      console.error('location fail', err);
    }, {enableHighAccuracy:true});
  }
  shareLocation();
  setInterval(shareLocation, 12000);

  socket.on('nearby_request', function(data){
    var el = document.getElementById('my-notifs');
    el.innerHTML = '<div>' + (data.message || '') + '</div>' + el.innerHTML;
  });

  socket.on('request_notification', function(data){
    var el = document.getElementById('my-notifs');
    el.innerHTML = '<div>' + (data.message || '') + '</div>' + el.innerHTML;
  });
</script>
{% endblock %}
