{% extends "base.html" %}
{% block title %}Request Blood{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-7">
    <div class="card p-3">
      <h4>Request Blood</h4>
      {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
      <form method="post" id="reqForm">
        <div class="mb-2"><label class="form-label">Patient Name</label><input name="patient_name" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Required Blood Group</label>
          <select name="required_blood_group" class="form-control">
            <option>O+</option><option>O-</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option>
          </select>
        </div>
        <div class="row g-2">
          <div class="col"><label class="form-label">Latitude</label><input id="latitude" name="latitude" class="form-control"></div>
          <div class="col"><label class="form-label">Longitude</label><input id="longitude" name="longitude" class="form-control"></div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button type="button" id="useLoc" class="btn btn-outline-secondary">Use Current Location</button>
          <button class="btn btn-danger" type="submit">Find Donors</button>
        </div>
      </form>

      <div class="mt-3">
        <h5>Matches</h5>
        <div id="map" class="mb-2"></div>
        <div id="matchList">
          <!-- server will render matches after POST -->
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-5">
    <div class="card p-3">
      <h5>Quick Actions</h5>
      <a href="{{ url_for('hospital_requests') }}" class="btn btn-outline-primary btn-sm mb-2">My Requests</a>
      <a href="{{ url_for('donors_list') }}" class="btn btn-outline-secondary btn-sm mb-2">View Donors</a>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    var map = L.map('map').setView([13.02,80.12], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    document.getElementById('useLoc').addEventListener('click', function(){
      if(!navigator.geolocation){ alert('No geolocation'); return; }
      navigator.geolocation.getCurrentPosition(function(p){
        document.getElementById('latitude').value = p.coords.latitude.toFixed(6);
        document.getElementById('longitude').value = p.coords.longitude.toFixed(6);
        map.setView([p.coords.latitude, p.coords.longitude], 13);
        L.marker([p.coords.latitude, p.coords.longitude]).addTo(map).bindPopup('Request location').openPopup();
      }, function(e){ alert(e.message); }, {enableHighAccuracy:true});
    });

    // when server returns matches it will render list and we leave socket listening
    var socket = io();
    socket.on('donor_updated', function(payload){
      // simple: add a circle marker for live updates
      if(payload.latitude && payload.longitude){
        L.circleMarker([payload.latitude, payload.longitude], {radius:6, color:'#b00'}).addTo(map).bindPopup(payload.name);
      }
    });
  </script>
{% endblock %}
