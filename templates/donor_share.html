{% extends "base.html" %}
{% block title %}Share Location{% endblock %}
{% block content %}
<div class="card p-3">
  <h4>Share Live Location</h4>
  <p>Press Start and allow the browser to send periodic location updates. These will be visible to hospitals when you accept a request.</p>
  <div class="d-flex gap-2">
    <button id="startBtn" class="btn btn-danger">Start Sharing</button>
    <button id="stopBtn" class="btn btn-secondary">Stop</button>
  </div>
  <div class="mt-3">
    <div id="status" class="small-muted">Not sharing</div>
    <div id="coords" class="small-muted"></div>
  </div>
</div>

<script>
  const socket = io();
  const donorId = {{ donor.id }};
  let watchId = null;
  document.getElementById('startBtn').addEventListener('click', ()=>{
    if(!navigator.geolocation){ alert("No geolocation"); return; }
    socket.emit('join_room', {room:'donors'});
    function sendPos(p){
      const lat = p.coords.latitude;
      const lon = p.coords.longitude;
      document.getElementById('status').innerText = 'Sharing...';
      document.getElementById('coords').innerText = lat.toFixed(5)+', '+lon.toFixed(5);
      socket.emit('donor_share', {donor_id: donorId, latitude: lat, longitude: lon});
    }
    navigator.geolocation.getCurrentPosition(sendPos, (e)=>alert(e.message), {enableHighAccuracy:true});
    watchId = navigator.geolocation.watchPosition(sendPos, (e)=>console.warn(e), {enableHighAccuracy:true, maximumAge:5000, timeout:10000});
  });
  document.getElementById('stopBtn').addEventListener('click', ()=>{
    if(watchId) navigator.geolocation.clearWatch(watchId);
    socket.emit('donor_offline', {donor_id: donorId});
    document.getElementById('status').innerText = 'Stopped';
  });
</script>
{% endblock %}
